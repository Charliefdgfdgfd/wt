<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Walkie-Talkie App</title>
</head>
<body>
    <h1>Walkie-Talkie App</h1>
    <button id="recordBtn">Record</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="playBtn" disabled>Play</button>
    <button id="sendBtn" disabled>Send</button>
    <input type="text" id="userName" placeholder="Enter your name">
    <input type="text" id="codeInput" placeholder="Enter code">

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioBlob;
        let audioUrl;
        let audio;

        document.getElementById('recordBtn').addEventListener('click', async () => {
            console.log('Record button clicked');
            
            try {
                audioChunks = [];  // Reset chunks for a new recording
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('Microphone access granted');
                
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                mediaRecorder.start();

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    audioUrl = URL.createObjectURL(audioBlob);
                    audio = new Audio(audioUrl);

                    // Debugging
                    console.log('Audio URL created:', audioUrl);
                    console.log('Audio object:', audio);

                    document.getElementById('playBtn').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    console.log('Recording stopped and processed');
                };

                document.getElementById('recordBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                console.log('Recording started');
            } catch (error) {
                console.error('Error accessing the microphone', error);
                alert('Failed to access the microphone. Please check permissions.');
            }
        });

        document.getElementById('stopBtn').addEventListener('click', () => {
            mediaRecorder.stop();

            document.getElementById('recordBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            console.log('Recording stopped');
        });

        document.getElementById('playBtn').addEventListener('click', () => {
            if (audio) {
                audio.play()
                    .then(() => {
                        console.log('Audio is playing');
                    })
                    .catch((err) => {
                        console.error('Error playing audio:', err);
                    });
            } else {
                console.log('Audio object is not defined');
            }
        });

        document.getElementById('sendBtn').addEventListener('click', async () => {
            const userName = document.getElementById('userName').value;
            const code = document.getElementById('codeInput').value;

            if (!userName || !code) {
                alert("Please enter your name and code.");
                return;
            }

            const formData = new FormData();
            formData.append('audio', audioBlob, `${userName}.webm`);  // Use correct extension
            formData.append('userName', userName);
            formData.append('code', code);

            await fetch('https://charliefdgfdgfd.github.io/wt/upload', {
                method: 'POST',
                body: formData,
            });

            alert("Audio sent!");
        });
    </script>
</body>
</html>
